<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ·»åŠ ä»»åŠ¡</title>
</head>
<body>
  <h1>â• æ·»åŠ ä»»åŠ¡</h1>

  <label>ä»»åŠ¡åç§°ï¼š<input id="name" type="text"></label><br>
  <label>å¼€å§‹æ—¥æœŸï¼š<input id="start" type="date"></label><br>
  <label>ç»“æŸæ—¥æœŸï¼š<input id="end" type="date"></label><br>
  <label>é¢„è®¡æ€»å°æ—¶æ•°ï¼š<input id="hours" type="number"></label><br>
  <label>æ¯æ—¥å¼€å§‹æ—¶é—´ï¼ˆå¦‚ 09:00ï¼‰ï¼š<input id="startTime" type="time"></label><br>
  <label>æ¯æ—¥ç»“æŸæ—¶é—´ï¼ˆå¦‚ 11:00ï¼‰ï¼š<input id="endTime" type="time"></label><br>

  <!-- âœ… åˆ†ç±»å­—æ®µ -->
  <label>ä»»åŠ¡åˆ†ç±»ï¼š
    <select id="category">
      <option value="ğŸ“š è®ºæ–‡ä»»åŠ¡">ğŸ“š è®ºæ–‡ä»»åŠ¡</option>
      <option value="ğŸ“– å­¦ä¹ ä»»åŠ¡">ğŸ“– å­¦ä¹ ä»»åŠ¡</option>
      <option value="ğŸ’ª å¥èº«ä»»åŠ¡">ğŸ’ª å¥èº«ä»»åŠ¡</option>
      <option value="ğŸ“ å…¶ä»–ä»»åŠ¡" selected>ğŸ“ å…¶ä»–ä»»åŠ¡</option>
    </select>
  </label><br><br>

  <!-- åœ¨â€œä»»åŠ¡åˆ†ç±»â€ä¸‹æ–¹æ·»åŠ  -->
  <label>ä¼˜å…ˆçº§ï¼š
    <select id="priority">
      <option value="é«˜">ğŸ”¥ é«˜</option>
      <option value="ä¸­" selected>âš¡ ä¸­</option>
      <option value="ä½">ğŸŒ± ä½</option>
    </select>
  </label><br><br>

  <button onclick="saveTask()">ä¿å­˜ä»»åŠ¡</button><br><br>
  <a href="index.html">â¬… è¿”å›é¦–é¡µ</a>

  <script>
  // æ£€æŸ¥æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
  const urlParams = new URLSearchParams(location.search);
  const editName = urlParams.get("edit");
  let isEdit = false;

  if (editName) {
    const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
    const task = tasks.find(t => t.name === editName);
    if (task) {
      isEdit = true;
      document.getElementById("name").value = task.name;
      document.getElementById("name").disabled = true; // åç§°ä¸å¯ç¼–è¾‘
      document.getElementById("start").value = task.start;
      document.getElementById("end").value = task.end;
      document.getElementById("hours").value = task.estimatedHours;
      document.getElementById("startTime").value = task.timeRange?.[0] || "";
      document.getElementById("endTime").value = task.timeRange?.[1] || "";
      document.getElementById("category").value = task.category || "ğŸ“ å…¶ä»–ä»»åŠ¡";
      document.getElementById("priority").value = task.priority || "ä¸­";
    }
  }

  function saveTask() {
    const task = {
      name: document.getElementById("name").value,
      start: document.getElementById("start").value,
      end: document.getElementById("end").value,
      estimatedHours: parseFloat(document.getElementById("hours").value),
      timeRange: [document.getElementById("startTime").value, document.getElementById("endTime").value],
      category: document.getElementById("category").value,
      priority: document.getElementById("priority").value
    };

    let tasks = JSON.parse(localStorage.getItem("tasks") || "[]");

    if (isEdit) {
      // ç¼–è¾‘æ¨¡å¼ï¼šæ›¿æ¢åŸä»»åŠ¡
      tasks = tasks.map(t => t.name === task.name ? task : t);
    } else {
      if (checkConflict(task, tasks)) {
        if (!confirm("âš ï¸ æ—¶é—´æ®µå­˜åœ¨å†²çªï¼Œä»è¦æ·»åŠ å—ï¼Ÿ")) return;
      }
      tasks.push(task);
    }

    localStorage.setItem("tasks", JSON.stringify(tasks));
    alert(isEdit ? "âœ… ä»»åŠ¡å·²æ›´æ–°ï¼" : "âœ… ä»»åŠ¡å·²ä¿å­˜ï¼");
    location.href = "index.html";
  }

  function checkConflict(newTask, existingTasks) {
    const newStart = new Date(newTask.start);
    const newEnd = new Date(newTask.end);
    const ts1 = newTask.timeRange;

    return existingTasks.some(task => {
      if (isEdit && task.name === newTask.name) return false; // ç¼–è¾‘æ—¶è·³è¿‡è‡ªå·±
      const existStart = new Date(task.start);
      const existEnd = new Date(task.end);
      const overlap = !(newEnd < existStart || newStart > existEnd);
      if (!overlap) return false;

      const ts2 = task.timeRange || ["00:00", "00:00"];
      return !(ts1[1] <= ts2[0] || ts1[0] >= ts2[1]);
    });
  }
  </script>
</body>
</html>