<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥åé¦ˆæ‰“å¡</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>âœ… æ¯æ—¥ä»»åŠ¡æ‰“å¡ä¸åé¦ˆ</h1>

  <div id="today-tasks"></div>
  <hr>

  <h3>ğŸ§  ç²¾ç¥çŠ¶æ€åé¦ˆ</h3>
  <label>ç–²åŠ³ç¨‹åº¦ï¼ˆ0-10ï¼‰ï¼š
    <input type="range" id="fatigue" min="0" max="10" value="5" oninput="updateFatigueValue(this.value)">
    <span id="fatigue-value">5</span>
  </label>
  <br><br>

  <label>æƒ…ç»ªçŠ¶æ€ï¼š
    <select id="mood">
      <option value="ğŸ˜ƒ å¾ˆå¼€å¿ƒ">ğŸ˜ƒ å¾ˆå¼€å¿ƒ</option>
      <option value="ğŸ™‚ ä¸€èˆ¬" selected>ğŸ™‚ ä¸€èˆ¬</option>
      <option value="ğŸ˜© ç´¯">ğŸ˜© ç´¯</option>
      <option value="ğŸ˜  çƒ¦èº">ğŸ˜  çƒ¦èº</option>
    </select>
  </label>
  <br><br>

  <label>å¤‡æ³¨ / ä»Šæ—¥å›°éš¾ï¼š</label><br>
  <textarea id="notes" rows="4" cols="40" placeholder="å¦‚ï¼šä»»åŠ¡è¿‡é‡ã€æ— æ³•é›†ä¸­ç­‰..."></textarea>
  <br><br>

  <button onclick="saveFeedback()">ğŸ’¾ æäº¤åé¦ˆ</button>
  <p id="save-status"></p>

  <hr>
  <button onclick="viewHistory()">ğŸ“Š æŸ¥çœ‹è¿‡å»åé¦ˆ</button>
  <div id="history"></div>

  <hr>
  <h3>ğŸ“ˆ å½“å‰ä»»åŠ¡è¿›åº¦ä¸€è§ˆ</h3>
  <div id="task-progress"></div>

  <script>
    const today = new Date().toISOString().split('T')[0];
    const tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
    const schedule = scheduleTasks(tasks);

    const taskBlock = document.getElementById("today-tasks");
    taskBlock.innerHTML = `<h3>ğŸ“… ${today} çš„ä»»åŠ¡</h3>`;

    if (schedule[today]) {
      schedule[today].forEach(item => {
        taskBlock.innerHTML += `<p>ğŸ“Œ ${item.name} (${item.timeRange?.[0] || "?"}~${item.timeRange?.[1] || "?"}) - ${item.hours}å°æ—¶</p>`;
      });
    } else {
      taskBlock.innerHTML += "<p>ğŸ‰ ä»Šå¤©æ— ä»»åŠ¡å®‰æ’</p>";
    }

    function updateFatigueValue(val) {
      document.getElementById("fatigue-value").innerText = val;
    }

    function saveFeedback() {
      const data = {
        fatigue: document.getElementById("fatigue").value,
        mood: document.getElementById("mood").value,
        notes: document.getElementById("notes").value
      };

      const feedback = JSON.parse(localStorage.getItem("dailyFeedback") || "{}");
      feedback[today] = data;
      localStorage.setItem("dailyFeedback", JSON.stringify(feedback));
      document.getElementById("save-status").innerText = "âœ… å·²ä¿å­˜åé¦ˆï¼";

      // æ¸…ç©ºè¾“å…¥
      document.getElementById("fatigue").value = 5;
      updateFatigueValue(5);
      document.getElementById("mood").value = "ğŸ™‚ ä¸€èˆ¬";
      document.getElementById("notes").value = "";
    }

    function viewHistory() {
      const feedback = JSON.parse(localStorage.getItem("dailyFeedback") || "{}");
      const sortedDates = Object.keys(feedback).sort().reverse().slice(0, 7);
      const historyBlock = document.getElementById("history");
      historyBlock.innerHTML = "<h4>ğŸ“† è¿‘7æ—¥åé¦ˆï¼š</h4>";
      if (sortedDates.length === 0) {
        historyBlock.innerHTML += "<p>æš‚æ— è®°å½•</p>";
        return;
      }
      sortedDates.forEach(date => {
        const f = feedback[date];
        historyBlock.innerHTML += `
          <p><strong>${date}</strong><br>
          ç–²åŠ³ï¼š${f.fatigue} / æƒ…ç»ªï¼š${f.mood}<br>
          å¤‡æ³¨ï¼š${f.notes || 'æ— '}</p>
        `;
      });
    }

    function scheduleTasks(tasks) {
      const schedule = {};
      tasks.forEach(task => {
        const start = new Date(task.start);
        const end = new Date(task.end);
        const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const dailyHours = (task.estimatedHours / days).toFixed(1);
        for (let i = 0; i < days; i++) {
          const date = new Date(start);
          date.setDate(date.getDate() + i);
          const dateStr = date.toISOString().split("T")[0];
          if (!schedule[dateStr]) schedule[dateStr] = [];
          schedule[dateStr].push({
            name: task.name,
            hours: dailyHours,
            timeRange: task.timeRange
          });
        }
      });
      return schedule;
    }

    function renderProgressOverview(tasks) {
      const now = new Date();
      const container = document.getElementById("task-progress");
      container.innerHTML = "";

      tasks.forEach(task => {
        const start = new Date(task.start);
        const end = new Date(task.end);
        const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const elapsedDays = Math.min(Math.max(Math.floor((now - start) / (1000 * 60 * 60 * 24)) + 1, 0), totalDays);
        const percent = Math.floor((elapsedDays / totalDays) * 100);

        let status = "æœªå¼€å§‹";
        if (now >= start && now <= end) status = "è¿›è¡Œä¸­";
        else if (now > end) status = "å·²å®Œæˆ";

        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";

        wrapper.innerHTML = `
          <strong>${task.name}</strong> (${task.start} ~ ${task.end})<br>
          çŠ¶æ€ï¼š<span>${status}</span> | è¿›åº¦ï¼š${percent}%<br>
          <div style="background:#eee;width:100%;height:10px;border-radius:4px;overflow:hidden;">
            <div style="height:10px;width:${percent}%;background:#4caf50;"></div>
          </div>
        `;
        container.appendChild(wrapper);
      });
    }

    renderProgressOverview(tasks);
  </script>
</body>
</html>
